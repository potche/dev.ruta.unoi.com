{% extends '::base.html.twig' %}
{% block body %}

    <div id="page-content">

        <div class="content-header">
            <div class="header-section">
                <h1>
                    {#app.request.basepath#}
                    {#app.request.baseurl#}
                    {# app.request.uri #}
                    <i class="fa fa-line-chart"></i><b>Estad&iacute;sticas</b>
                    <small><br/><span class="label label-primary"><span class="nameSchool"></span> </span></small>
                    <small><br/><span class="label label-primary"><span class="nameSurvey"></span> </span></small>
                </h1>
            </div>
        </div>

        <div class="block">
            <div class="block-title">
                <h2>Filtro</h2>
            </div>
            <div class="row">
                <div class="block-content">
                    <form id="schoolFrm">
                        <div id="divSchool" class="col-sm-6">
                            <strong>Escuela</strong>
                            <input type="text" id="schoolIdFrm" name="schoolIdFrm" class="form-control input-typeaheadSchool" autocomplete="off" placeholder="Busca escuelas..">
                        </div>

                        <!-- Success Alert Content -->
                        <div id="divContentSchool" class="col-sm-6" style="display: none">
                            <div class="alert alert-success alert-dismissable">
                                <button id="closeSchool" type="button" class="close" >&times;</button>
                                <h4><i class="fa fa-university"></i> <strong><span class="nameSchool"></span></strong></h4>
                            </div>
                        </div>
                        <!-- END Success Alert Content -->

                        <div id="divSurvey" class="col-sm-6">
                            <strong>Evaluación</strong>
                            <input type="text" id="surveyIdFrm" name="surveyIdFrm" class="form-control input-typeaheadSurvey" autocomplete="off" placeholder="Busca evaluación..">
                        </div>

                        <!-- Success Alert Content -->
                        <div id="divContentSurvey" class="col-sm-6" style="display: none">
                            <div class="alert alert-info alert-dismissable">
                                <button id="closeSurvey" type="button" class="close" >&times;</button>
                                <h4><i class="fa fa-pencil-square-o"></i> <strong><span class="nameSurvey"></span></strong></h4>
                            </div>
                        </div>
                        <!-- END Success Alert Content -->

                        <div id="errorBuscar" class="alert alert-danger col-sm-12 text-center" style="display: none">
                            <div id="mensajeSchool" style="display: none">
                                <h5><i class="fa fa-times"></i> Ingrese una <strong>Escuela Valida</strong></h5>
                            </div>
                            <div id="mensajeSurvey" style="display: none">
                                <h5><i class="fa fa-times"></i> Ingrese una <strong>Evaluación Valida</strong></h5>
                            </div>
                        </div>

                        <div class="col-sm-12 text-center form-group form-actions">
                            <button id="buscar" type="button" class="btn btn-sm btn-primary" onclick="findFilter();" disabled ><i class="fa fa-search"></i> Buscar</button>
                            <button id="todo" type="button" class="btn btn-sm btn-warning" onclick="resetFilter()" disabled ><i class="fa fa-repeat"></i> Avance Global</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="block-resumen" class="block">
            <div class="block-title">
                <div class="block-options pull-right">
                    <a href="javascript:void(0)" class="btn btn-info btn-sm btn-primary" data-toggle="block-toggle-content"><i class="fa fa-arrows-v"></i></a>
                </div>
                <h2>Gr&aacute;ficas de avance <strong><span class="nameSchool"></span></strong></h2>
            </div>

            <div id="withGraphs" class="row">
                <div class="block-content">
                    <div class="col-sm-6">
                        <div id="pie" class="block">
                            <div id="container"></div>
                        </div>
                    </div>
                </div>
                <div class="block-content">
                    <div class="col-sm-6">
                        <div id="bars" class="block">
                            <div id="containerColumn"></div>
                        </div>
                    </div>
                </div>
            </div>


            <div id="withOutGraphs" class="row" style="display: none">
                <div class="block-content">
                    <div class="col-sm-12 text-center">
                        <div class="block">
                            <h1>No se ha realizado ninguna <strong>evaluación</strong>.</h1>
                            <div class="carousel slide" data-ride="carousel">
                                <div class="carousel-inner" role="listbox">
                                    <div class="item active">
                                        <h2 class="text-center"><span class="fa fa-bed fa-2x"></span></h2>
                                    </div>
                                    <div class="item">
                                        <h2 class="text-center"><span class="fa fa-thumbs-down fa-2x"></span></h2>
                                    </div>
                                    <div class="item">
                                        <h2 class="text-center"><span class="fa fa-hourglass-end fa-2x"></span></h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div id="block-resumenT" class="block" style="display: none">
            <div class="block-title">
                <div class="block-options pull-right">
                    <a href="javascript:void(0)" class="btn btn-info btn-sm btn-primary" data-toggle="block-toggle-content"><i class="fa fa-arrows-v"></i></a>
                </div>
                <h2>Tabla de avance <strong><span class="nameSchool"></span></strong></h2>
            </div>
            <div class="row">
                <div class="block-content">
                    <div class="col-sm-12">
                        <small class="visible-xs"><i class="fa fa-info-circle text-primary"></i> Puedes navegar horizontalmente para ver las demás columnas</small>
                        <div class="table-responsive">
                            <p>Estad&iacute;sticas de usuarios que han realizado por lo menos una evaluación. <em>Da <b>click</b> sobre un usuario para ver su detalle</em></p>
                            <table id="userList-datatable" class="table table-vcenter table-condensed table-bordered">
                                <thead>
                                    <tr>
                                        <th style="width: 150px;" class="text-center"><i class="fa fa-users"></i></th>
                                        <th>Nombre</th>
                                        <th style="width: 150px;" class="text-center">Progreso</th>
                                        <th class="text-center">Detalle</th>
                                    </tr>
                                </thead>
                                <tbody id="userList">
                                </tbody>
                            </table>
                            <br/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END Page Content -->

    <!-- Modal Stats User -->
    <div id="statsUser" class="modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title"><i class="fa fa-rebel"></i> Estad&iacute;sticas por <strong>usuario</strong></h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm-12">
                            <img src="{{ asset('public/assets/images/login/icon_niño1.png') }}" alt="avatar" class="img-circle">
                            <h1><span class="userName"></span></h1>
                            <div id="avanceUser"></div>
                            <small><em>Porcentaje de avance</em></small>
                            <hr>
                            <div id="selectSurveys" class="well"></div>
                        </div>
                    </div>


                    <span id="bodyStatsUser"></span>

                    <div id="block-resumenG" class="block">
                        <div class="block-title">
                            <h2>Gr&aacute;ficas de <strong>avance</strong></h2>
                        </div>
                        <div class="row">
                            <div class="block-content ">

                                <div class="col-sm-12 col-md-6 col-lg-6">
                                    <div class="block">
                                        <div id="containerPieLU" ></div>
                                    </div>
                                </div>
                            </div>
                            <div class="block-content ">
                                <div class="col-sm-12  col-md-6 col-lg-6">
                                    <div class="block">
                                        <div id="containerColumnLU"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="surveyUser">
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- END Modal Stats User -->


    <!-- Modal loading -->
    <div id="loadingStats" class="modal" tabindex="-1" role="dialog" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-body bg-primary text-center">
                    <h4 class="modal-title"><i class="fa fa-refresh fa-spin"></i> Cargando, <strong>por favor espere...</strong></h4>
                </div>
            </div>
        </div>
    </div>
    <!-- END Modal loading -->


    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <!-- Load and execute javascript code used only in this page -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-3d.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="{{ asset('public/assets/js/validateSchoolSurvey.js') }}"></script>
    <script src="{{ asset('public/assets/js/statsGraph.js')}}"></script>
    <script>
        var schoolArrayG = [];
        var schoolListJS = {{ schoolList | raw }};
        var surveyListJS = {{ surveyList | raw }};
        var okSchool = true;
        var okSurvey = true;
        var nameSchool = 'Todas las Escuelas';
        var nameSurvey = 'Todas las Evaluaciones';

        var serverAllAPI = "{{ app.request.getSchemeAndHttpHost() }}{{ app.request.getBaseURL() }}/api/v0/stats/results";
        var serverSchoolSurveyAPI = "{{ app.request.getSchemeAndHttpHost() }}{{ app.request.getBaseURL() }}/api/v0/stats/results/survey/3/school/";
        var serverSchoolAPI = "{{ app.request.getSchemeAndHttpHost() }}{{ app.request.getBaseURL() }}/api/v0/stats/results/school/";
        var serverSurveyAPI = "{{ app.request.getSchemeAndHttpHost() }}{{ app.request.getBaseURL() }}/api/v0/stats/results/survey/";


        $(function() {
            setNameSchool(nameSchool);
            setNameSurvey(nameSurvey);
            $('.input-typeaheadSchool').typeahead({ source: schoolListJS });
            $('.input-typeaheadSurvey').typeahead({ source: surveyListJS });

            graphsAll(serverAllAPI, nameSchool, nameSurvey);

            var mensajeSchool = $('#mensajeSchool');
            var mensajeSurvey = $('#mensajeSurvey');
            var errorBuscar = $('#errorBuscar');
            var buscar = $("#buscar");
            var schoolIdFrm = $('#schoolIdFrm');
            var surveyIdFrm = $('#surveyIdFrm');

            $('#schoolIdFrm').change(function(){

                if(schoolIdFrm.val() != '') {
                    if (schoolListJS.indexOf(schoolIdFrm.val()) != -1) {
                        mensajeSchool.hide();
                        okSchool = true;
                        showErrorBuscar(okSchool, okSurvey, schoolIdFrm, surveyIdFrm);
                    } else {
                        errorBuscar.show('fast');
                        mensajeSchool.show();
                        buscar.prop('disabled', true);
                        okSchool = false;
                    }
                }else{
                    mensajeSchool.hide();
                    okSchool = true;
                    showErrorBuscar(okSchool, okSurvey, schoolIdFrm, surveyIdFrm);
                }


            });

            $('#surveyIdFrm').change(function() {

                if(surveyIdFrm.val() != ''){
                    if (surveyListJS.indexOf( surveyIdFrm.val() ) != -1) {
                        mensajeSurvey.hide();
                        okSurvey = true;
                        showErrorBuscar(okSchool, okSurvey, schoolIdFrm, surveyIdFrm);
                    }else{
                        errorBuscar.show('fast');
                        mensajeSurvey.show();
                        buscar.prop('disabled', true);
                        okSurvey = false;
                    }
                }else{
                    mensajeSurvey.hide();
                    okSurvey = true;
                    showErrorBuscar(okSchool, okSurvey, schoolIdFrm, surveyIdFrm);
                }
            });

        });



        function detalle(personId, userName, avance, surveyName){

            graphsUser('http://dev.evaluaciones.unoi.com/app_dev.php/api/v0/stats/results/person/'+personId, userName, surveyName);

            $('.userName').html(userName);
            $('#avanceUser').html('<div class="progress progress-striped active">'+
                                    '<div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="'+avance+'" aria-valuemin="0" aria-valuemax="100" style="width: '+avance+'%;">'+avance+'%</div>'+
                                '</div>');
            $('#statsUser').modal('show');
        }

        function graphsUser(serverAPI, userName, surveyName){
            $.ajax({
                url: serverAPI,
                dataType: 'json',
                success: function(results){
                    createGraphsUser(results.global, userName, 'Todas las Evaluaciones');
                    var list = '';
                    $.each( results.byPerson, function( key, value ) {
                        $.each( value.evaluaciones, function( key2, item ) {
                            if(item.estatus == '4'){
                                list += "<option value='"+item.id+"|"+JSON.stringify(item.opciones)+"|"+userName+"|"+item.titulo+"'>"+item.titulo+"</option>";
                            }else{

                            }
                        });
                    });

                    $('#selectSurveys').html(
                            "<h5>Selecciona alguna evaluación para ver su <b>detalle</b>:</h5>"+
                            "<select id='evaluacioLU' class='form-control' size='1' onchange='(abc(this.value))'>"+
                            "<option value='"+JSON.stringify(results.global)+"'>Global</option>" + list + "" +
                            "</select>"
                    );
                }
            });
        }

        function createGraphsUser(results, userName, surveyName){
            if(typeof results =='object'){
                // It is JSON
            }else{
                results = $.parseJSON(results);
            }
            pieGrlLU(results, userName, surveyName);
            columnGrlLU(results, userName, surveyName);
        }

        function abc(rs){
            console.log(rs);
            var arr = rs.split('|');
            createGraphsUser(arr[1],arr[2], arr[3]);
            /*
            if(arr[3] != 0){
                $.post( "ajax/stats", { title: arr[3], personId: personIdGlobal })
                        .done(function( data ) {
                            $('#surveyUser').html( data );
                            TablesDatatables2.init();
                        });
            }else{
                $('#surveyUser').html( '' );
            }
            */
        }

        var TablesDatatables = function(col) {
            return {
                init: function() {
                    /* Initialize Bootstrap Datatables Integration */
                    App.datatables();

                    /* Initialize Datatables */
                    $('#userList-datatable').dataTable({
                        columnDefs: [ { orderable: false, targets: [ 0, col ] } ],
                        pageLength: 5,
                        lengthMenu: [[5,10,15,20,25,30, -1], [5,10,15,20,25,30, 'All']],
                        paging: true,
                        searching: true
                    });

                    /* Add placeholder attribute to the search input */
                    $('.dataTables_filter input').attr('placeholder', 'buscar');
                }
            };
        }();
    </script>

{% endblock %}